# duck_nav2_config/config/nav2_params.yaml

amcl:
  ros__parameters:
    use_sim_time: True
    min_particles: 500
    max_particles: 2000
    initial_pose:
      x: 0.0
      y: 0.0
      yaw: 0.0

planner_server:
  ros__parameters:
    use_sim_time: True
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_planner::SmacPlanner"
      tolerance: 0.5 # tolerance to goal

controller_server:
  ros__parameters:
    use_sim_time: True
    controller_frequency: 10.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.5
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.3
    progress_checker_plugin: "progress_checker"
    goal_checker_plugin: "goal_checker"
    controller_plugins: ["FollowPath"]

    # Progress Checker Configuration
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.5
      movement_time_allowance: 10.0

    # Goal Checker Configuration
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25

    # DWB Controller Configuration
    FollowPath:
      plugin: "dwb_core::DWBLocalPlanner"
      debug_trajectory_details: False
      min_vel_x: 0.0
      min_vel_y: 0.0
      max_vel_y: 0.0
      max_vel_theta: 1.0
      min_speed_theta: 0.0
      # Add max_vel_x back if you want to limit forward speed
      max_vel_x: 0.3 
      # Add these to tune acceleration
      acc_lim_x: 2.5
      acc_lim_y: 0.0
      acc_lim_theta: 3.2
      decel_lim_x: -2.5
      decel_lim_y: 0.0
      decel_lim_theta: -3.2
      # THIS IS THE CRITICAL PART: The critics
      critics: ["RotateToGoal", "Oscillation", "BaseObstacle", "GoalAlign", "PathAlign", "PathDist", "GoalDist"]
      BaseObstacle.scale: 0.02
      PathAlign.scale: 32.0
      PathAlign.forward_point_distance: 0.1
      GoalAlign.scale: 24.0
      GoalAlign.forward_point_distance: 0.1
      PathDist.scale: 32.0
      GoalDist.scale: 24.0
      RotateToGoal.scale: 32.0
      RotateToGoal.sim_angle: 65.0

costmap:
  global_costmap:
    global_costmap:
      ros__parameters:
        use_sim_time: True
        resolution: 0.05
        robot_radius: 0.22 # IMPORTANT: Set this to your robot's radius
        plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
        static_layer:
          plugin: "nav2_costmap_2d::StaticLayer"
          map_subscribe_transient_local: True
        obstacle_layer:
          plugin: "nav2_costmap_2d::ObstacleLayer"
          enabled: True
          scan:
            topic: "/scan"
            max_obstacle_height: 2.0
            origin_z: 0.0
            z_resolution: 0.2
            z_voxels: 2
            unknown_threshold: 15
            mark_threshold: 0
            combination_method: 1
            track_unknown_space: False
            obstacle_max_range: 2.5
            obstacle_min_range: 0.0
            raytrace_max_range: 3.0
            raytrace_min_range: 0.0
            clearing: True
            marking: True
            data_type: "LaserScan"
        inflation_layer:
          plugin: "nav2_costmap_2d::InflationLayer"
          cost_scaling_factor: 3.0 # How much the cost increases as you get closer to an obstacle
          inflation_radius: 0.55 # The radius at which obstacles start to affect the costmap

  local_costmap:
    local_costmap:
      ros__parameters:
        use_sim_time: True
        update_frequency: 5.0
        publish_frequency: 2.0
        resolution: 0.05
        robot_radius: 0.22 # IMPORTANT: Same as global
        plugins: ["obstacle_layer", "inflation_layer"]
        obstacle_layer:
          plugin: "nav2_costmap_2d::ObstacleLayer"
          # ... (same configuration as global obstacle_layer)
        inflation_layer:
          plugin: "nav2_costmap_2d::InflationLayer"
          # ... (same configuration as global inflation_layer)
